# XLog's Life Time inside Storage Node

## 1. What is XLog's Life Time?
In the `How does Compute Node directly commit XLogs  to Storage Nodes?` section, we mentioned how does XLog are generated by compute nodes and sent to the storage nodes 
via XLog file mapping. In this section, we will introduce when XLogs are flushed to the storage nodes, how does the storage nodes handle these XLogs, and which 
part of the storage nodes will these XLogs go through.

## 2. How does Storage Node XLog parser realise there is a new XLog?

We implement the XLog parser based on PostgreSQL's StartupXLog() function.

Firstly, let we introduce this functin's workflow a little.
The StartupXLog() function will be called when the PostgreSQL instance is started. It will check whether there is a valid XLog 
metadata file in the storage, which contains its latest checkpoint LSN.
After then the StartupXLog() will replay the XLogs from the latest checkpoint LSN to the latest XLog LSN. 
When there is no more XLogs to read, it will return.

However, it this PostgreSQL instance is a standby node, the StartupXLog() will not return. Instead, when it detected that 
it reaches the end of XLog, it will send a signal to the PostMaster process, and then the PostMaster process will 
start a WAL receiver process to connect with the primary instance, and keep receiving XLogs from the master node.

When XLog arrives, the WAL receiver process will write the XLog to the disk, and then send a signal to the StartupXLog()'s process,
which will wake up the StartupXLog() function, and then the StartupXLog() function will try to read the XLog from the disk. 

After successfully read the XLog, the StartupXLog() function will call the corresponding resource manager to replay the XLog and then back to
wait for the next XLog.

For our implementation, we will not use the WAL receiver process. Instead, we will use the RPC server to receive the XLog from the compute node.
When the RPC server receives the XLog, it will write the XLog to the disk, and then send a signal to the StartupXLog()'s process, which will wake up the StartupXLog() function, and then the StartupXLog() function will try to read the XLog from the disk.
After successfully read the XLog, the StartupXLog() function will call the corresponding resource manager to parse the XLog into the LogIndex.

## 3. When will these XLogs be replayed?

As we mentioned in the `What is LogIndex?` section, there will have two scenario that the XLog will be used again.
1. When a page is requested by a query, the rpc server will check LogIndex to see which page version should be returned. If there is no page version in LogIndex, the rpc server will get the base version of this page from the storage node. If there is a page version in LogIndex, the rpc server will check whether the page has been generated already. If not, the rpc server will get the latest version of this page, and also gather corresponding XLogs from the storage node, and then replay these XLogs to generate the page version.
2. The background thread will replay the XLog asynchronously. This thread will check the LogIndex to see whether there is any Xlog that can be replayed. If there is, the thread will replay the XLog. If not, the thread will sleep for a while, and then check again.